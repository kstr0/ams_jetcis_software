#!/bin/bash
HOME="$( cd ~  >/dev/null 2>&1 && pwd )"
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
cd $DIR
export PYTHONPATH=$PYTHONPATH:$DIR

zenity --warning --title "JetCis Installer" --text "Make sure that all instances of JetCis viewer are closed\nand you are not within the JetCis folder.\nOtherwise installation might fail." --width=400

echo "Update Repository"
sudo apt-get update

echo "Install python packages"
sudo apt-get -y install python3-pip
sudo apt-get -y install python3-tk
sudo apt-get -y install python3-pil.imagetk
sudo apt-get -y install python3-matplotlib
pip3 install v4l2

echo "Install multimedia packages"
sudo apt-get -y install build-essential cmake git pkg-config libgtk-3-dev
sudo apt-get -y install libavcodec-dev libavformat-dev libswscale-dev libv4l-dev libxvidcore-dev libx264-dev
sudo apt-get -y install libjpeg-dev libpng-dev libtiff-dev gfortran openexr libatlas-base-dev
sudo apt-get -y install python3-dev python3-numpy libtbb2 libtbb-dev libdc1394-22-dev
sudo apt-get -y install libgstreamer1.0-dev 
sudo apt-get -y install libgstreamer-plugins-base1.0-dev
sudo apt-get -y install v4l-utils

echo "Install other useful packages"
sudo apt-get -y install subversion
sudo apt-get -y install nano
sudo apt-get -y install lsof

echo "Fix v4l2 python library issue"
sudo cp v4l2.py /usr/local/lib/python3.6/dist-packages/v4l2.py
sudo cp v4l2.py ~/.local/lib/python3.6/site-packages/v4l2.py

echo "Install Application to $HOME/JetCis , user: $USER"

if [ -d "$HOME/JetCis" ]
then
	echo "...remove old Application folder"
	sudo rm -rf ~/JetCis
fi
cp -rf ../App3/. ~/JetCis

echo "Prepare customized kernel infrastructure"
sudo cp ./extlinux.conf /boot/extlinux/extlinux.conf
sudo cp ./dtbnano.dtb /boot/dtbnano.dtb
if [ -f "/boot/sensor.conf" ]
then
	sudo rm /boot/sensor.conf
fi

echo "Remove other temporary files"
if [ -f "/tmp/SyncServer.tmp" ]
then
	sudo rm /tmp/SyncServer.tmp
fi

echo "turn off lens shading"
sudo cp camera_overrides.isp /var/nvidia/nvcam/settings/camera_overrides.isp
sudo chown root:root /var/nvidia/nvcam/settings/camera_overrides.isp
sudo chmod 664 /var/nvidia/nvcam/settings/camera_overrides.isp

echo "Create Desktop Icon"
echo "[Desktop Entry]" > ~/Desktop/JetCis.desktop
echo "Version=1.0" >> ~/Desktop/JetCis.desktop
echo "Type=Application" >> ~/Desktop/JetCis.desktop
echo "Terminal=true" >> ~/Desktop/JetCis.desktop
echo "Exec=$HOME/JetCis/startPy.sh" >> ~/Desktop/JetCis.desktop
echo "Name=JetCis" >> ~/Desktop/JetCis.desktop
echo "Comment=JetCis" >> ~/Desktop/JetCis.desktop
echo "Icon=$HOME/JetCis/logo.png" >> ~/Desktop/JetCis.desktop
echo "Set the script rights accordingly"
sudo chmod +x ~/Desktop/JetCis.desktop
sudo chmod +x ~/JetCis/startPy.sh
sudo chmod +x ~/JetCis/start.sh
sudo chown -R $USER $HOME/JetCis
gio set ~/Desktop/JetCis.desktop "metadata::trusted" yes

zenity --info --title "JetCis Installer" --text "Installation is done.\nPlease reboot the system to make sure,\nall changes are applied." --width=300
